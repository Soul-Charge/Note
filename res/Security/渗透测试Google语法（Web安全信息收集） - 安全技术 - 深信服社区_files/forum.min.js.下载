/*! sangforbbs 2020-11-26 */
angular.module("databases.common",[]),angular.module("databases.common").controller("CaseTagController",function($scope,$rootScope,$location,caseThreadService,$timeout,productData,productList){function getVersionTag(){caseThreadService.getProductTag(productData.id,3).success(function(res){res.status&&($scope.thread.versionTag=res.data)})}$scope.$watchGroup(["thread.params.orderby","thread.params.versionTag"],function(newValue,oldValue,scope){(newValue[0]!=oldValue[0]||newValue[1]!=oldValue[1])&&$scope.getThreadList()}),$rootScope.thread?$scope.thread=$rootScope.thread:$scope.thread={params:{orderby:"dateline",starttime:"",endtime:"",tags:"",searchkey:"",page:1,limit:20,versionTag:"",moduleTag:"",cpid:productData.id},threadList:null,mainTag:[],childTag:[],versionTag:[],isLoading:!1,productData:JSON.parse(JSON.stringify(productData)),productList:productList,selectMainTag:""},$scope.getThreadList=function(isPage){isPage||($scope.thread.params.page=1),$scope.thread.isLoading=!0,caseThreadService.fetchThread($scope.thread.params).success(function(res){res.status&&($scope.thread.isLoading=!1,$scope.thread.threadList=res.data,$scope.thread.params.page=$scope.thread.params.page,$scope.state.per=res.count,$scope.state.count=res.total,$rootScope.thread=$scope.thread)})},$scope.thread.threadList||$scope.getThreadList(),$scope.$watchGroup(["thread.params.cpid"],function(newValue,oldValue,scope){$scope.thread.selectMainTag="";for(var i=0;i<productList.length;i++)productList[i].id==$scope.thread.params.cpid&&($scope.thread.productData=JSON.parse(JSON.stringify(productList[i])),productData=JSON.parse(JSON.stringify(productList[i])));$scope.getThreadList()}),$scope.selectTag=function(key,mainId,ckey,childId){$scope.thread.selectMainTag==mainId&&-1==ckey?($scope.thread.productData=JSON.parse(JSON.stringify(productData)),$scope.thread.productData.mainTag[key].checked=!1,$scope.thread.selectMainTag=""):$scope.thread.selectMainTag==mainId?$scope.thread.productData.mainTag[key].childs[ckey].checked=!$scope.thread.productData.mainTag[key].childs[ckey].checked:($scope.thread.productData=JSON.parse(JSON.stringify(productData)),$scope.thread.productData.mainTag[key].checked=!0,$scope.thread.selectMainTag=mainId,ckey>=0&&($scope.thread.productData.mainTag[key].childs[ckey].checked=!0));var selectArr=[];$scope.thread.productData.mainTag[key].checked&&(angular.forEach($scope.thread.productData.mainTag[key].childs,function(ctag,key){ctag.checked&&selectArr.push(ctag.id)}),0==selectArr.length&&selectArr.push($scope.thread.productData.mainTag[key].id)),$scope.thread.params.moduleTag=selectArr.join(","),$scope.getThreadList()},$scope.setOrderBy=function(orderby){$scope.thread.params.orderby=orderby},$scope.inputKeyUp=function(e){(13==window.event.keyCode||""==$scope.thread.params.searchkey&&8==window.event.keyCode)&&$scope.getThreadList()},jQuery(document).on("click","#calendar .pn",function(){$scope.thread.params.starttime=angular.element("#time-start-input")[0].value,$scope.thread.params.endtime=angular.element("#time-end-input")[0].value,$scope.getThreadList()}),$scope.isHasChild=function(inputArr,pid){for(key in inputArr)if(inputArr[key].pid==pid)return!0;return!1},getVersionTag()}),angular.module("databases.common").controller("downloadViewController",["$scope","$rootScope","$routeParams","$location","$modal","$timeout","data","userGroup","ruleService","product","softwareProductList",function($scope,$rootScope,$routeParams,$location,$modal,$timeout,data,userGroup,ruleService,product,softwareProductList){if("software"==$location.$$path.split("/")[1]){for(var i=0;i<softwareProductList.length;i++)softwareProductList[i].product.ID==$routeParams.softfid&&(data=softwareProductList[i].data,product=softwareProductList[i].product);if(!$routeParams.softfid&&data.length)return void $location.url("/software/"+product.ID);if(!$routeParams.typeId&&data.length)return void $location.url("/software/"+$routeParams.softfid+"/"+data[0].ID);!$routeParams.visionId&&data[0].data.length&&($location.url("/software/"+$routeParams.softfid+"/"+$routeParams.typeId+"/all"),$routeParams.visionId="all"),$rootScope.software_typeId=$routeParams.typeId,$rootScope.software_visionId=$routeParams.visionId,$rootScope.software_softfid=$routeParams.softfid;var params={};window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(str,key,value){params[key]=value}),$scope.allVersion={},params.fid=$rootScope.software_softfid;var i,j,typeLength,typeItem,visionItem,dataLength=data.length,typeId=$routeParams.typeId,visionId=$routeParams.visionId,typeData=[],visionData=[{ID:"all",Title:"全部"}];for($scope.$root.downloadViewStatus={curVersion:typeId||dataLength&&data[0].ID},$rootScope.softOptions={softfid:$rootScope.software_softfid,softwareProductList:softwareProductList,product:data},$rootScope.$watchGroup(["softOptions.softfid"],function(newValue,oldValue,scope){if(newValue[0]!=oldValue[0]||newValue[1]!=oldValue[1])for(var i=0;i<softwareProductList.length;i++)if(softwareProductList[i].product.ID==$rootScope.softOptions.softfid){var letdata=softwareProductList[i].data;softwareProductList[i].product;$location.url("/software/"+$rootScope.softOptions.softfid+"/"+letdata[0].ID+"/all")}}),i=0;dataLength>i;i++)if(typeItem=data[i],"100000005741878"!=typeItem.ID&&"100000012046287"!=typeItem.ID&&(typeData.push({ID:typeItem.ID,Title:typeItem.Title}),typeItem.ID==typeId))for(j=0,typeLength=typeItem.data.length;typeLength>j;j++)visionItem=typeItem.data[j],visionData.push({ID:visionItem.ID,Title:visionItem.Title}),visionItem.ID==visionId?$scope.detailData=[visionItem]:"all"===visionId&&($scope.detailData=typeItem.data),$scope.commonData=typeItem.common;"100000010657812"===params.fid?(typeData.push({ID:"adesk",Title:"ROM"},{ID:"adeskrule",Title:"应用管控规则库"}),$scope.tipSN={},_adeskData=$scope.adeskData={vmpId:"",vdcId:"",SN:""},$scope.adeskruleData=[],ruleService.fetchAdesk().success(function(respone){respone&&respone.data&&($scope.aDesk=respone.data.data,_adeskData.vmpId=$scope.aDesk.vmp[0].vmp_id,_adeskData.vdcId=$scope.aDesk.vdc[0].vdc_id)}),ruleService.fetchVersion(1).success(function(respone){respone&&($scope.allVersion=respone,$scope.adeskruleData=respone[0].version)})):"100000003677756"===params.fid&&(typeData.push({ID:"afrule",Title:"内置规则库"}),ruleService.fetchType().success(function(respone){respone&&respone.data&&($scope.visionData=visionData.concat(respone.data.data))}),ruleService.fetchVersion(2).success(function(respone){respone&&($scope.allVersion=respone,$scope.afruleData=respone[0].version)})),$scope.select_rule_version_type=function(){"100000010657812"===params.fid?$scope.adeskruleData=$scope.allVersion[$scope.params.selectedVersion].version:"100000003677756"===params.fid&&($scope.afruleData=$scope.allVersion[$scope.params.selectedVersion].version)},$scope.$root.typeData=typeData,$scope.visionData=visionData,$scope.typeId=typeId,$scope.vision=visionId,$scope.discuzUid=parseInt(discuz_uid),$scope.userGroup=userGroup,$scope.$watch("vision",function(newValue){newValue&&$location.url("/software/"+$routeParams.softfid+"/"+$routeParams.typeId+"/"+newValue)}),$scope.copyUrl=function(url){$modal.open({animation:!0,templateUrl:"copyModalContent.html",controller:"ModalInstanceCtrl",backdrop:"static",resolve:{items:function(){return{url:url}}}}).rendered.then(function(){angular.element('.modal-dialog input[type="text"]').focus().select()})},$scope.authentication=function(){showError("获取渠道认证后才可以下载"),$timeout(function(){window.location.href="home.php?mod=spacecp&ac=channel"},2e3)},$scope.adeskSearch=function(){var testcode=/^[a-zA-Z0-9]{10}$/;return $scope.tipSN.errors=!0,void 0==_adeskData.SN||""==_adeskData.SN?$scope.tipSN.tipmsg="此项不为空":testcode.test(_adeskData.SN)?($scope.isLoading=!0,$scope.tipSN.errors=!1,$scope.tipSN.tipmsg="",ruleService.fetchAdeskRom(_adeskData).success(function(respone){respone&&respone.data&&($scope.romData=respone.data.data,$scope.isSearch=!0,$scope.isLoading=!1)})):$scope.tipSN.tipmsg="请输入正确的S/N码",$scope.tipSN.errors}}}]).controller("ModalInstanceCtrl",["$scope","$modalInstance","items",function($scope,$modalInstance,items){$scope.url=items.url,$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]).factory("ruleService",["$http",function($http){return{fetchType:function(){return $http.get("plugin.php?id=service:download&inajax=1&op=ruleType&ajaxdata=json")},fetchRule:function(ruleType){return $http.get("plugin.php?id=service:download&inajax=1&op=rule&ajaxdata=json&type="+ruleType)},fetchAllRule:function(ruleType){return $http.get("plugin.php?id=service:download&inajax=1&op=all_rule&ajaxdata=json&rule_type="+ruleType)},fetchAdesk:function(){return $http.get("plugin.php?id=service:download&inajax=1&op=adesk&ajaxdata=json")},fetchVersion:function(ruleType){return $http.get("plugin.php?id=service:download&action=rule_version_info&rule_type="+ruleType)},fetchAdeskRom:function(option){return $http({method:"post",url:"plugin.php?id=service:download&inajax=1&op=rom&ajaxdata=json",data:option})}}}]),angular.module("databases.common").controller("NewTagController",function($scope,$rootScope,filterService,$location,threadService,tagsData){function initFilters(filters,searchObj){angular.forEach(filters,function(filterArr,type){var codeArr=searchObj[type];void 0!==codeArr&&(codeArr=angular.isArray(codeArr)?codeArr:[codeArr],angular.forEach(codeArr,function(code){filterService.switchFilter(type,code,!0)}))})}function updateThread(options){threadPromise&&threadPromise.abort(),$scope.state.isLoading=!0,threadPromise=threadService.fetchThread(options),threadPromise.success(function(data){if(data){if("dateline"==$scope.state.orderby?$scope.state.display="最新发表":"lastpost"==$scope.state.orderby?$scope.state.display="最新回复":$scope.state.display="时间排序",angular.isArray(data.data))$scope.state.threadList=data.data,$scope.state.count=data.count,$scope.state.per=data.total,$rootScope.updatedoc&&($scope.state.tags.doc=data.doctags),$scope.state.selectTags=data.select_tags,$scope.warning=data.warning,$scope.state.versiontags=data.versiontags,$scope.state.versionTag=data.versionTag;else{for(var responseData=data.data.data,threadListData=[],responseItem=[],i=0,l=responseData.length;l>i;i++)responseItem=responseData[i],threadListData.push({downloads:responseItem.downloads,TypeName:responseItem.datatagname,versionName:responseItem.versionName,author:responseItem.author,id:responseItem.tid,read:responseItem.views,time:1e3*responseItem.dbdateline,title:responseItem.subject,score:responseItem.score});$scope.state.threadList=threadListData,$scope.state.count=data.data.count,$scope.state.per=data.data.pre,$rootScope.updatedoc&&($scope.state.tags.doc=data.data.doctags),$scope.state.selectTags=data.data.select_tags,$scope.warning=data.data.warning,$scope.state.versiontags=data.data.versiontags,$scope.state.versionTag=data.data.versionTag}$rootScope.newstate=$scope.state}})["finally"](function(){threadPromise=null,$scope.state.isLoading=!1;var going_click=getcookie("sf_click_id");going_click&&angular.element("#"+going_click)[0]&&("open_data_feekback"==going_click&&$scope.$parent.openQuickPost(15),setcookie("sf_click_id",""))})}function initSearchFilter(keyword){keyword?filterService.filters.keyword=keyword:delete filterService.filters.keyword}var str=window.location.hash.substr(2),cutHash=[],lastHash=[];str&&(cutHash=str.split("&"),lastHash=cutHash[cutHash.length-1].split("=")),$rootScope.newstate?$scope.state=$rootScope.newstate:$scope.state={filters:filterService.filters,tags:tagsData,orderby:"dateline",isLoading:!1,currentPage:1,threadList:null,selectTags:[],display:"最新发表",versiontags:null,versionTag:"",isNew:!0,datatagid:tagsData.datatagid,datataglist:tagsData.datataglist},$rootScope.updatedoc=1,$scope.search=function(keyword){initSearchFilter(keyword)};var threadPromise=null;$scope.$watchGroup(["state.datatagid"],function(newValue,oldValue,scope){newValue[0]==oldValue[0]&&newValue[1]==oldValue[1]||$scope.state.isLoading||updateThread({page:scope.state.currentPage,filters:{tags:["79","80",$scope.state.datatagid]},orderby:scope.state.orderby,version:scope.version,updatedoc:$rootScope.updatedoc,versionTag:scope.state.versionTag})}),$scope.$watch(function(scope){var state=scope.state;return[state.filters,state.orderby,state.currentPage,state.versionTag]},function(newVal,oldVal,scope){for(var i=0;i<newVal.length;i++)if(!(newVal[i]==oldVal[i]&&$scope.state.threadList||$scope.state.isLoading))return updateThread({page:scope.state.currentPage,filters:{tags:["79","80",$scope.state.datatagid]},orderby:scope.state.orderby,version:scope.version,updatedoc:$rootScope.updatedoc,versionTag:scope.state.versionTag}),!1},!0),initFilters(filterService.filters,$location.search()),$scope.$watch(function(){return filterService.filters},function(val){$scope.state.currentPage=1,$location.search(val)},!0)}),angular.module("databases.common").controller("PlateController",function($scope,$rootScope,$location){switch($scope.plateParam={showIndex:0},$location.$$path.split("/")[1]){case"case":$scope.plateParam.showIndex=1;break;case"new":$scope.plateParam.showIndex=2;break;case"software":$scope.plateParam.showIndex=3;break;case"tool":$scope.plateParam.showIndex=4;break;case"forum":$scope.plateParam.showIndex=5}$scope.switchPlateIndex=function(index){$scope.plateParam.showIndex=index,jQuery(window).scrollTop(0)}}),angular.module("databases.common").controller("TagController",function($scope,$rootScope,filterService,$location,threadService,tagsData){function initFilters(filters,searchObj){angular.forEach(filters,function(filterArr,type){var codeArr=searchObj[type];void 0!==codeArr&&(codeArr=angular.isArray(codeArr)?codeArr:[codeArr],angular.forEach(codeArr,function(code){filterService.switchFilter(type,code,!0)}))})}function updateThread(options){threadPromise&&threadPromise.abort(),$scope.state.isLoading=!0,threadPromise=threadService.fetchThread(options),threadPromise.success(function(data){if(data){if("dateline"==$scope.state.orderby?$scope.state.display="最新发表":"lastpost"==$scope.state.orderby?$scope.state.display="最新回复":$scope.state.display="时间排序",angular.isArray(data.data))$scope.state.threadList=data.data,$scope.state.count=data.count,$scope.state.per=data.total,$rootScope.updatedoc&&($scope.state.tags.doc=data.doctags),$scope.state.selectTags=data.select_tags,$scope.warning=data.warning,$scope.state.versiontags=data.versiontags,$scope.state.versionTag=data.versionTag;else{for(var responseData=data.data.data,threadListData=[],responseItem=[],i=0,l=responseData.length;l>i;i++)responseItem=responseData[i],threadListData.push({downloads:responseItem.downloads,TypeName:responseItem.datatagname,versionName:responseItem.versionName,author:responseItem.author,id:responseItem.tid,read:responseItem.views,time:1e3*responseItem.dbdateline,title:responseItem.subject,score:responseItem.score});$scope.state.threadList=threadListData,$scope.state.count=data.data.count,$scope.state.per=data.data.pre,$rootScope.updatedoc&&($scope.state.tags.doc=data.data.doctags),$scope.state.selectTags=data.data.select_tags,$scope.warning=data.data.warning,$scope.state.versiontags=data.data.versiontags,$scope.state.versionTag=data.data.versionTag}$rootScope.state=$scope.state}})["finally"](function(){threadPromise=null,$scope.state.isLoading=!1;var going_click=getcookie("sf_click_id");going_click&&angular.element("#"+going_click)[0]&&("open_data_feekback"==going_click&&$scope.$parent.openQuickPost(15),setcookie("sf_click_id",""))})}function initSearchFilter(keyword){keyword?filterService.filters.keyword=keyword:delete filterService.filters.keyword}var str=window.location.hash.substr(2),cutHash=[],lastHash=[];str&&(cutHash=str.split("&"),lastHash=cutHash[cutHash.length-1].split("=")),$rootScope.state?$scope.state=$rootScope.state:$scope.state={filters:filterService.filters,tags:tagsData,orderby:"dateline",isLoading:!1,currentPage:1,threadList:null,selectTags:[],display:"最新发表",versiontags:null,versionTag:"",datatagid:tagsData.datatagid,datataglist:tagsData.datataglist,selectDataTag:""},$scope.selectOnlyOneFilter=function(tagid){$scope.state.selectDataTag==tagid?$scope.state.selectDataTag="":$scope.state.selectDataTag=tagid;var newtags=[$scope.state.datatagid];$scope.state.selectDataTag&&newtags.push($scope.state.selectDataTag),updateThread({page:$scope.state.currentPage,filters:{tags:newtags},orderby:$scope.state.orderby,version:$scope.version,updatedoc:$rootScope.updatedoc,versionTag:$scope.state.versionTag})},$rootScope.updatedoc=1,$scope.search=function(keyword){initSearchFilter(keyword)};var threadPromise=null;$scope.$watchGroup(["state.datatagid"],function(newValue,oldValue,scope){if((newValue[0]!=oldValue[0]||newValue[1]!=oldValue[1])&&!$scope.state.isLoading){var newtags=[$scope.state.datatagid];$scope.state.selectDataTag&&newtags.push($scope.state.selectDataTag),updateThread({page:scope.state.currentPage,filters:{tags:newtags},orderby:scope.state.orderby,version:scope.version,updatedoc:$rootScope.updatedoc,versionTag:scope.state.versionTag})}}),$scope.$watch(function(scope){var state=scope.state;return[state.filters,state.orderby,state.currentPage,state.versionTag]},function(newVal,oldVal,scope){for(var i=0;i<newVal.length;i++)if(!(newVal[i]==oldVal[i]&&$scope.state.threadList||$scope.state.isLoading)){var newtags=[$scope.state.datatagid];return $scope.state.selectDataTag&&newtags.push($scope.state.selectDataTag),updateThread({page:scope.state.currentPage,filters:{tags:newtags},orderby:scope.state.orderby,version:scope.version,updatedoc:$rootScope.updatedoc,versionTag:scope.state.versionTag}),!1}},!0),initFilters(filterService.filters,$location.search()),$scope.$watch(function(){return filterService.filters},function(val){$scope.state.currentPage=1,$location.search(val)},!0)}),angular.module("databases.common").directive("casethread",function(APP_PATH){return{restrict:"EA",replace:!0,scope:{data:"="},templateUrl:APP_PATH+"/view/case-thread.html?v="+VERHASH,controller:function($scope,APP_URL){$scope.link="forum.php?mod=viewthread&tid="+$scope.data.tid}}}),angular.module("databases.common").directive("thread",function(APP_PATH){return{restrict:"EA",replace:!0,scope:{data:"="},templateUrl:APP_PATH+"/view/thread.html?v="+VERHASH,controller:function($scope,APP_URL){$scope.link=APP_URL+"&mod=viewdatabase&tid="+$scope.data.id}}}),angular.module("databases.common").filter("collection",function(){return function(inputArr,matchObj){var result=[];return angular.forEach(inputArr,function(item){var isMatch=!0;angular.forEach(matchObj,function(arr,prop){return arr.length&&-1===arr.indexOf(item[prop])?(isMatch=!1,!1):void 0}),isMatch&&result.push(item)}),result}}),angular.module("forum",[]).controller("forumActiveController",function($scope,$q,$http,$location,$modal,activityList,advert,commonService,fid){var navList=activityList.carry_arr,len=navList.length,allList=[],moreList=[];if(len>5)for(var i=0;len>i;i++)if(5>i)for(item in activityList.allList)activityList.allList[item].id==navList[i]&&allList.push(activityList.allList[item]);else for(item in activityList.allList)activityList.allList[item].id==navList[i]&&moreList.push(activityList.allList[item]);else for(var i=0;len>i;i++)for(item in activityList.allList)activityList.allList[item].id==navList[i]&&allList.push(activityList.allList[item]);var _data=$scope.data={image:[1,2,3,4],sortList:["最新发表","最新回复","最多回复","热门"],showItem:"最新发表",navList:allList,moreList:moreList,navShowList:"a",all:!0,more:!1,moreListShow:!1,moreItemShow:"a",active:1,sortListBool:!1,retthreads:activityList.retthreads,advert:advert,bool:1,page:1,orderby:"dateline",typeid:"",inp:"",endList:[],allList:[],carry_arr:[],moreitem:"更多"};$scope.getList=function(url,bool){_data.retthreads=[],_data.page=1,_data.bool=2;var promise=commonService.fetch(url).then(function(res){bool?(_data.retthreads=res.data.data.data,res.data.retthreads=res.data.data.data,_data.endList=res.data.over_arr,_data.allList=res.data.allList,_data.carry_arr=res.data.carry_arr):(_data.endList=res.data.over_arr,_data.allList=res.data.allList,_data.retthreads=res.data.retthreads,_data.carry_arr=res.data.carry_arr),res.data.retthreads&&res.data.retthreads.length>=20?_data.bool=1:_data.bool=3});return promise},$scope.showSortList=function(){_data.sortListBool=!_data.sortListBool,_data.moreListShow=!1},$scope.changeShowItem=function(item){_data.showItem=item,_data.sortListBool=!1,_data.moreListShow=!1,"最新回复"==item&&(_data.orderby="lastpost"),"最新发表"==item&&(_data.orderby="dateline"),"最多回复"==item&&(_data.orderby="replies"),"热门"==item&&(_data.orderby="heats"),_data.inp?url="sf.php?mod=search&action=thread&type=activity&orderby="+_data.orderby+"&ac_status="+_data.active+(_data.typeid?"&ac_typeid="+_data.typeid.split("=")[1]:"")+"&record="+!0+"&query="+_data.inp+"&page=1":url="forum.php?mod=forumdisplay&fid="+fid+"&type=ajax_activity&status="+_data.active+"&page=1&orderby="+_data.orderby+_data.typeid,$scope.getList(url,Boolean(_data.inp))},$scope.changeNavItem=function(index,id){_data.typeid="&typeid="+id,_data.inp?url="sf.php?mod=search&action=thread&type=activity&orderby="+_data.orderby+"&ac_status="+_data.active+"&ac_typeid="+id+"&record="+!0+"&query="+_data.inp+"&page=1":url="forum.php?mod=forumdisplay&fid="+fid+"&type=ajax_activity&page=1&status="+_data.active+"&typeid="+id+"&orderby="+_data.orderby,$scope.getList(url,Boolean(_data.inp)),_data.all=!1,_data.more=!1,_data.navShowList=index,_data.moreListShow=!1,_data.moreItemShow="a"},$scope.changeAll=function(){_data.typeid="",_data.inp?url="sf.php?mod=search&action=thread&type=activity&orderby="+_data.orderby+"&ac_status="+_data.active+(_data.typeid?"&ac_typeid="+_data.typeid.split("=")[1]:"")+"&record="+!0+"&query="+_data.inp+"&page=1":url="forum.php?mod=forumdisplay&fid="+fid+"&type=ajax_activity&status="+_data.active+"&page=1&orderby="+_data.orderby,$scope.getList(url,Boolean(_data.inp)),_data.all=!0,_data.navShowList="a",_data.more=!1,_data.moreListShow=!1,_data.moreItemShow="a"},$scope.changeMore=function(){_data.moreListShow=!_data.moreListShow},$scope.changeActive=function(index){_data.retthreads=[],_data.typeid="",_data.active=index,_data.inp?url="sf.php?mod=search&action=thread&type=activity&orderby="+_data.orderby+"&ac_status="+_data.active+"&record="+!0+"&query="+_data.inp+"&page=1":url="forum.php?mod=forumdisplay&fid="+fid+"&type=ajax_activity&status="+index+"&page=1&orderby="+_data.orderby,$scope.getList(url,Boolean(_data.inp)).then(function(){if(_data.all=!0,_data.navShowList="a",2==index){var navList=JSON.parse(JSON.stringify(_data.endList)),len=navList.length,allList=[],moreList=[];if(len>5){for(var i=0;len>i;i++)if(5>i)for(item in _data.allList)_data.allList[item].id==navList[i]&&allList.push(_data.allList[item]);else for(item in _data.allList)_data.allList[item].id==navList[i]&&moreList.push(_data.allList[item]);_data.navList=allList,_data.moreList=moreList}else{for(var i=0;len>i;i++)for(item in _data.allList)_data.allList[item].id==navList[i]&&allList.push(_data.allList[item]);_data.navList=allList,_data.moreList=[]}}else{var navList=JSON.parse(JSON.stringify(_data.carry_arr)),len=navList.length,allList=[],moreList=[];if(len>5)for(var i=0;len>i;i++)if(5>i)for(item in _data.allList)_data.allList[item].id==navList[i]&&allList.push(_data.allList[item]);else for(item in _data.allList)_data.allList[item].id==navList[i]&&moreList.push(_data.allList[item]);else for(var i=0;len>i;i++)for(item in _data.allList)_data.allList[item].id==navList[i]&&allList.push(_data.allList[item])}_data.moreList=moreList,_data.navList=allList})},$scope.showMore=function(index,id,type){$scope.data.moreitem=type,_data.typeid="&typeid="+id,_data.inp?url="sf.php?mod=search&action=thread&type=activity&orderby="+_data.orderby+"&ac_status="+_data.active+(_data.typeid?"&ac_typeid="+_data.typeid.split("=")[1]:"")+"&record="+!0+"&query="+_data.inp+"&page=1":url="forum.php?mod=forumdisplay&fid="+fid+"&type=ajax_activity&status="+_data.active+"&typeid="+id+"&page=1&orderby="+_data.orderby,$scope.getList(url,Boolean(_data.inp)),_data.more=!0,_data.all=!1,_data.navShowList="a",_data.moreItemShow=index},$scope.getMoreList=function(){_data.page=_data.page+1,_data.bool=2,_data.inp?url="sf.php?mod=search&action=thread&type=activity&orderby="+_data.orderby+"&ac_status="+_data.active+(_data.typeid?"&ac_typeid="+_data.typeid.split("=")[1]:"")+"&record="+!0+"&query="+_data.inp+"&page="+_data.page:url="forum.php?mod=forumdisplay&fid="+fid+"&type=ajax_activity&status="+_data.active+_data.typeid+"&page="+_data.page+"&orderby="+_data.orderby;commonService.fetch(url).then(function(res){if(_data.inp&&(res.data.retthreads=res.data.data.data),res.data.retthreads){for(var len=res.data.retthreads.length,i=0;len>i;i++)_data.retthreads.push(res.data.retthreads[i]);res.data.retthreads.length>20?_data.bool=1:_data.bool=3}else _data.bool=3})},$scope.searchEvent=function(){_data.inp?url="sf.php?mod=search&action=thread&type=activity&orderby="+_data.orderby+"&ac_status="+_data.active+(_data.typeid?"&ac_typeid="+_data.typeid.split("=")[1]:"")+"&record="+!0+"&query="+_data.inp+"&page=1":url="forum.php?mod=forumdisplay&fid="+fid+"&type=ajax_activity&status="+_data.active+_data.typeid+"&page=1&orderby="+_data.orderby,$scope.getList(url,Boolean(_data.inp))},jQuery(".d-contran .contran .activity .title .inp").keyup(function(e){13==e.keyCode&&$scope.searchEvent()})}),angular.module("post",["page"]).controller("PostController",["$scope","PostService",function($scope,PostService){function initCaseTag(product_id){var hasTagArray=hasCaseTag.split(",");PostService.getProductTag(product_id,1,null).success(function(res){$scope.childTags=[];for(var i=0;i<res.data.length;i++){res.data[i].checked=0;for(key in hasTagArray)if(res.data[i].id==hasTagArray[key]){res.data[i].checked=1;break}res.data[i].checked&&PostService.getProductTag(product_id,2,null,res.data[i].id).success(function(childres){for(var i=0;i<childres.data.length;i++){childres.data[i].checked=0;for(key in hasTagArray)if(childres.data[i].id==hasTagArray[key]){childres.data[i].checked=1;break}}$scope.childTags=$scope.childTags.concat(childres.data)})}$scope.mainTags=res.data}),PostService.getProductTag(product_id,3,null).success(function(res){for(var i=0;i<res.data.length;i++){res.data[i].checked=0;for(key in hasTagArray)if(res.data[i].id==hasTagArray[key]){res.data[i].checked=1;break}}$scope.versionTags=res.data})}if(void 0!=jQuery("#extra_tag_c").attr("ng-tag")){taglist=JSON.parse(jQuery("#extra_tag_c").attr("ng-tag"));var groupid=JSON.parse(jQuery("#extra_tag_c").attr("data-groupid")),adminid=JSON.parse(jQuery("#extra_tag_c").attr("data-adminid"));$scope.showAdminTag=function(id){return"1"==id?1==groupid||2==groupid||1==adminid||2==adminid?!0:!1:!0},$scope.showTagsList=[],$scope.isadminBool=!0,$scope.allTagsList=taglist;for(var i=0;i<$scope.allTagsList.length;i++)$scope.allTagsList[i].new_labelid=$scope.allTagsList[i].labelid,"1"==$scope.allTagsList[i].isadmin&&($scope.isadminBool=!1),$scope.allTagsList[i].labelid&&$scope.showTagsList.push($scope.allTagsList[i]);$scope.showTagsList.length>=5&&setTimeout(function(){jQuery(".new-alltagitem").each(function(index,item){jQuery(item).hasClass("active")||jQuery(item).addClass("disabled")})},1)}$scope.adminTipBool=!0,$scope.changeAdminTipBool=function(){$scope.adminTipBool=!1},$scope.addShow=function(item){if($scope.isadminBool){for(var bool=!1,i=0;i<$scope.showTagsList.length;i++)item.title===$scope.showTagsList[i].title&&($scope.showTagsList[i].new_labelid=null,$scope.showTagsList.splice(i,1),jQuery(".new-alltagitem").each(function(index,item){jQuery(item).removeClass("disabled")}),bool=!0);bool||($scope.showTagsList.length>=5&&showTipAlert("标签个数不能超过5个"),$scope.showTagsList.length<5&&($scope.showTagsList.push(item),item.new_labelid=!0,$scope.showTagsList.length>=5&&setTimeout(function(){jQuery(".new-alltagitem").each(function(index,item){jQuery(item).hasClass("active")||jQuery(item).addClass("disabled")})},1)))}},$scope.removeShow=function(item){item.new_labelid=null,$scope.showTagsList.splice($scope.showTagsList.indexOf(item),1),jQuery(".new-alltagitem").each(function(index,item){jQuery(item).removeClass("disabled")})},$scope.changeThreadType=function(typeid){$scope.showReward=12==typeid},$scope.changeForumType=function(fid){PostService.getThreadType(fid).success(function(data){var i=0,l=0,html="",$threadType=angular.element("#threadType"),$typeIdInput=$threadType.find('input[type="hidden"]'),oldTypeId=$typeIdInput.val(),hasTypeId=!1;if(data.success){for(html="<li>",i=0,l=data.data.length;l>i;i++){var d=data.data[i];html+=18==d.typeid?'<a data-value="'+d.typeid+'" href="forum.php?mod=post&action=newthread&typeid=18">'+d.name+"</a>":'<a data-value="'+d.typeid+'" href="javascript:">'+d.name+"</a>",d.typeid==oldTypeId&&(hasTypeId=!0)}html+="</li>"}$threadType.find(".dropdown-menu").empty().append(html),hasTypeId||($typeIdInput.val(0),$threadType.find('[ng-bind="display"]').html("请选择主题")),data.allowmediacode?(angular.element("#"+editorid+"_aud").length||angular.element("#e_adv_s1").append('<a id="'+editorid+'_aud" title="添加音乐">音乐</a>'),angular.element("#"+editorid+"_vid").length||angular.element("#e_adv_s1").append('<a id="'+editorid+'_vid" title="添加视频">视频</a>'),angular.element("#"+editorid+"_fls").length||angular.element("#e_adv_s1").append('<a id="'+editorid+'_fls" title="添加 Flash">Flash</a>'),initEditor()):(angular.element("#"+editorid+"_aud").remove(),angular.element("#"+editorid+"_vid").remove(),angular.element("#"+editorid+"_fls").remove())}),PostService.getAllowbbcode(fid).success(function(data){window.allowbbcode=data>>>0})},"undefined"!=typeof caseDataCpid&&caseDataCpid&&""!=caseDataCpid&&0!=caseDataCpid&&($scope.mainTags=[],$scope.childTags=[],$scope.versionTags=[],initCaseTag(caseDataCpid)),$scope.changeCaseProductType=function(productId){initCaseTag(productId)},$scope.selectMainTag=function(tag,index){if($scope.mainTags[index].checked=!$scope.mainTags[index].checked,$scope.mainTags[index].checked)PostService.getProductTag(tag.product_id,2,null,tag.id).success(function(res){for(var i=0;i<res.data.length;i++)res.data[i].checked=0;$scope.childTags=$scope.childTags.concat(res.data),$scope.childTags=$scope.childTags.sort(function(t1,t2){return parseInt(t1.id)<parseInt(t2.id)?-1:1})});else{for(var newChildArray=[],i=0;i<$scope.childTags.length;i++)$scope.childTags[i].main_id!=tag.id&&newChildArray.push($scope.childTags[i]);$scope.childTags=newChildArray.sort(function(t1,t2){return parseInt(t1.id)<parseInt(t2.id)?-1:1})}}}]).service("PostService",["$http",function($http){return{getThreadType:function(fid){return $http.post("forum.php?mod=threadclass&action=get",{fid:fid})},getAllowbbcode:function(fid){return $http.post(location.href+"&getinfo=allowbbcode&fid="+fid)},getProductTag:function(productId,type,pid,mainId){return $http.post("sf.php?mod=forum&action=get_case_product_tag",{product_id:productId,type:type,pid:pid,main_id:mainId})},getThemetag:function(tid,tagids){return $http.post("forum.php?mod=post&action=getthemetag",{tid:tid})}}}]),angular.module("databases.common").factory("articleService",function($http,$sce,userService,APP_URL,URL,$q){function fetch(option){return option=angular.extend({tid:userService.data("tid"),page:0},option),$http({method:"get",url:option.url||URL.comments,params:option}).then(function(respone){var data=respone.data;return data.comments=[],angular.forEach(data.postlist,function(comment){+comment.first?data.article=reformCommentObj(comment):data.comments.push(reformCommentObj(comment)),aimgcount[comment.pid]=angular.isArray(comment.aimgs)?comment.aimgs:[comment.aimgs]}),respone})}function reformCommentObj(obj){var comment=angular.extend({},obj),subComments=[];return angular.forEach(comment.comments,function(obj){subComments.push(reformCommentObj(obj))}),angular.extend(comment,{username:comment.author,avatar:comment.avatar,content:$sce.trustAsHtml(comment.message),floor:transformFloor(+comment.number),time:comment.dateline,
typeStatus:+comment.type_status,comments:subComments,imagelistHtml:$sce.trustAsHtml(comment.imagelistHtml)})}function transformFloor(num){switch(num){case 2:return"沙发";case 3:return"板凳";case 4:return"地板";default:return num}}function replyComment(option){var deferred=$q.defer(),data=angular.extend({fid:userService.data("fid"),formhash:userService.data("formhash"),ajaxdata:"json",message:option.content,usesig:1,reppid:option.pid,reppost:option.pid},option);return delete data.uid,delete data.pid,delete data.content,delete data.username,delete data.timestamp,$http({method:"post",url:option.url||URL.reply,data:data}).then(function(rsp){var data=rsp.data;data.data&&data.data.pid?fetch({viewpid:data.data.pid}).then(function(respone){deferred.resolve(respone)}):(data.message&&showError(data.message),deferred.reject(rsp))},function(rsp){data.message&&showError(data.message),deferred.reject(rsp)}),deferred.promise}function createCommentObj(option){return option=option||{},angular.extend({uid:userService.data("uid"),username:userService.data("username"),tid:userService.data("tid"),pid:null,content:"",timestamp:Date.now()},option)}function fetchFavoriteStatus(option){var url="home.php?mod=spacecp&ac=favorite&type=thread&id="+userService.data("tid")+"&formhash="+userService.data("formhash")+"&ajaxdata=json";return option.favoriteStatus&&(url+="&op=delete&deletesubmit=true"),$http({url:url})}return{isFirstPage:!0,fetch:fetch,replyComment:replyComment,createCommentObj:createCommentObj,reformCommentObj:reformCommentObj,fetchFavoriteStatus:fetchFavoriteStatus}}),angular.module("databases.common").factory("caseThreadService",function($http,$q,URL){function fetchThread(options){var canceler=$q.defer(),promise=null;return promise=$http({method:"post",url:URL.getThread,timeout:canceler.promise,data:options}),promise.abort=function(){canceler.resolve()},promise}function getProductTag(productId,type,pid,mainId){var canceler=$q.defer(),promise=null;return promise=$http({method:"post",url:URL.getTag,timeout:canceler.promise,data:{product_id:productId,type:type,pid:pid,main_id:mainId}}),promise.abort=function(){canceler.resolve()},promise}function getManageThread(params){var canceler=$q.defer(),promise=null;return promise=$http({method:"post",url:URL.getManageThread,timeout:canceler.promise,data:params}),promise.abort=function(){canceler.resolve()},promise}return{fetchThread:fetchThread,getProductTag:getProductTag,getManageThread:getManageThread}}),angular.module("databases.common").factory("filterService",function($http,$rootScope,URL,tradeData){function fetchType(v){return $http({method:"get",url:URL.site,params:{action:"type",version:v}})}function clearFilter(type){void 0!==type?filters[type].length=0:angular.forEach(filters,function(filterArr){filterArr.length=0})}function switchFilter(type,code,addOrDelete){var index;code=+code,index=filters[type].indexOf(code),!addOrDelete&&-1===index||addOrDelete?filters[type].push(code):filters[type].splice(index,1)}function selectOnlyOneFilter(type,code,tup,updatedoc){switchFilter(type,code,tup),void 0!==updatedoc&&updatedoc?$rootScope.updatedoc=1:$rootScope.updatedoc=0}function hasFilter(type,code){return-1!==filters[type].indexOf(+code)}function hasTupFilter(tup){if(thisSub=tradeTags[tup],void 0!==thisSub)for(var i=0;i<thisSub.length;i++)if(subIndex=filters.tags.indexOf(thisSub[i]),-1!==subIndex)return!0;return!1}var filters={tags:[],pType:[],dType:[],version:[]},tradeTags=tradeData;return{filters:filters,fetchType:fetchType,clearFilter:clearFilter,switchFilter:switchFilter,hasFilter:hasFilter,selectOnlyOneFilter:selectOnlyOneFilter,hasTupFilter:hasTupFilter}}),angular.module("databases.common").factory("newFilterService",function($http,$rootScope,URL,tradeData){function fetchType(v){return $http({method:"get",url:URL.site,params:{action:"type",version:v}})}function clearFilter(type){void 0!==type?filters[type].length=0:angular.forEach(filters,function(filterArr){filterArr.length=0})}function switchFilter(type,code,addOrDelete){var index;code=+code,index=filters[type].indexOf(code),!addOrDelete&&-1===index||addOrDelete?filters[type].push(code):filters[type].splice(index,1)}function selectOnlyOneFilter(type,code,tup,updatedoc){switchFilter(type,code,tup),void 0!==updatedoc&&updatedoc?$rootScope.updatedoc=1:$rootScope.updatedoc=0}function hasFilter(type,code){return-1!==filters[type].indexOf(+code)}function hasTupFilter(tup){if(thisSub=tradeTags[tup],void 0!==thisSub)for(var i=0;i<thisSub.length;i++)if(subIndex=filters.tags.indexOf(thisSub[i]),-1!==subIndex)return!0;return!1}var filters={tags:[],pType:[],dType:[],version:[]},tradeTags=tradeData;return{filters:filters,fetchType:fetchType,clearFilter:clearFilter,switchFilter:switchFilter,hasFilter:hasFilter,selectOnlyOneFilter:selectOnlyOneFilter,hasTupFilter:hasTupFilter}}),angular.module("databases.common").factory("sfSelectService",function($http,APP_URL,URL){function setStatus(option){return $http({url:"forum.php?mod=op",method:"post",data:{op:option.op,tid:option.tid,pid:option.pid}})}return{setStatus:setStatus}}),angular.module("databases.common").factory("threadService",function($http,$q,URL){function fetchThread(options){var canceler=$q.defer(),promise=null;if(options.filters.keyword){var data={};data.action="database",data.page=options.page,data.version=options.version,data.query=options.filters.keyword,data.orderby=options.orderby,data.versionTag=options.versionTag,options.filters.tags.length&&(data.databasetagids=options.filters.tags),data.typeid=14,promise=$http({method:"post",url:"sf.php?mod=search",timeout:canceler.promise,data:data})}else promise=$http({method:"post",url:URL.site,timeout:canceler.promise,data:{action:"thread",page:options.page,filters:options.filters,orderby:options.orderby,version:options.version,updatedoc:options.updatedoc,versionTag:options.versionTag}});return promise.abort=function(){canceler.resolve()},promise}return{fetchThread:fetchThread}}),angular.module("databases.common").factory("userService",function($http,URL){function updateUserData(option){return option=option||{},$http({method:"get",url:option.url||URL.site,params:{action:"user",tid:userData.tid}}).success(function(data){angular.extend(userData,data)})}function data(key){return key?userData[key]:angular.extend({},userData)}function getParameterByName(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?&]"+name+"=([^&#]*)"),results=regex.exec(location.search);return null===results?"":decodeURIComponent(results[1].replace(/\+/g," "))}var userData={uid:discuz_uid,fid:"undefined"!=typeof fid?fid:0,username:username,groupId:0,tid:"undefined"!=typeof fid?tid:0||+getParameterByName("tid"),formhash:null};return{updateUserData:updateUserData,data:data,getParameterByName:getParameterByName}}),angular.module("plateTagApp",["ngRoute","ngSanitize"]).constant("APP_PATH","webapp/module/forum").constant("APP_URL","plugin.php?id=sangfor_databases:index").constant("URL",{path:"webapp/module/forum",site:"plugin.php?id=sangfor_databases:index&mod=1",reply:"forum.php?mod=post&action=reply&replysubmit=yes&infloat=yes&handlekey=fastpost",comments:"forum.php?mod=viewthread&datatype=json",getThread:"sf.php?mod=case_thread&action=get_thread_list",getTag:"sf.php?mod=forum&action=get_case_product_tag",getManageThread:"sf.php?mod=forum&action=get_manage_thread_list"}).config(function($routeProvider,URL){$routeProvider.when("/case",{templateUrl:URL.path+"/view/case-tag-page.html",reloadOnSearch:!1,controller:"CaseTagController"}).when("/new",{templateUrl:URL.path+"/view/tag-page.html",reloadOnSearch:!1,controller:"NewTagController"}).when("/software/:softfid?/:typeId?/:visionId?",{templateUrl:"downloadViewTemplate.html",controller:"downloadViewController"}).otherwise({templateUrl:URL.path+"/view/tag-page.html",reloadOnSearch:!1,controller:"TagController"})}),angular.module("viewthread",["page","ngRoute"]).config(["$routeProvider",function($routeProvider){function GetQueryString(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)"),r=window.location.search.substr(1).match(reg);return null!=r?unescape(r[2]):null}var tid=GetQueryString("tid"),page=GetQueryString("page");page=page?page:1,$routeProvider.when("/",{templateUrl:"forum.php?mod=viewthread&tid=&tid="+tid+"&postlist=1&page="+page}).otherwise({redirectTo:"/"})}]).controller("replyCtrl",function($scope,threadData,memberData,postlistData,commonService,$timeout){var _state=$scope.state={isOpen:!1,uid:memberData.uid,tid:threadData.tid,pid:null};commonService.fetch("forum.php?mod=post&action=getthemetag",{tid:threadData.tid}).success(function(res){$scope.showTagsList=[],$scope.allTagsList=res.taglist,$scope.showNewTagsBool=!1;for(var i=0;i<$scope.allTagsList.length;i++)$scope.allTagsList[i].new_labelid=$scope.allTagsList[i].labelid,$scope.allTagsList[i].labelid&&$scope.showTagsList.push($scope.allTagsList[i]);$scope.showTagsList.length>=5&&setTimeout(function(){jQuery(".new-alltagitem").each(function(index,item){jQuery(item).hasClass("active")||jQuery(item).addClass("disabled")})},100)}),jQuery("body").click(function(e){jQuery(e.target).closest(".new-tags-after").length||($scope.showNewTagsBool=!1)}),$scope.showSubBool=!1,$scope.keeptagBool=!1,$scope.stopPropaga=function(){window.event.stopPropagation()},$scope.showTagList=function(){$scope.showNewTagsBool=!$scope.showNewTagsBool},$scope.addShow=function(item){for(var bool=!1,i=0;i<$scope.showTagsList.length;i++)item.id===$scope.showTagsList[i].id&&($scope.showTagsList[i].new_labelid=null,$scope.showTagsList.splice(i,1),$scope.showSubBool=!0,jQuery(".new-alltagitem").each(function(index,item){jQuery(item).removeClass("disabled")}),bool=!0);return bool?void 0:$scope.showTagsList.length>=5?void showTipAlert("标签个数不能超过5个"):($scope.showSubBool=!0,void($scope.showTagsList.length<5&&($scope.showTagsList.push(item),item.new_labelid=item.id,$scope.showTagsList.length>=5&&setTimeout(function(){jQuery(".new-alltagitem").each(function(index,item){jQuery(item).hasClass("active")||jQuery(item).addClass("disabled")})},10))))},$scope.removeShow=function(item){$scope.showSubBool=!0,item.new_labelid=null,$scope.showTagsList.splice($scope.showTagsList.indexOf(item),1),jQuery(".new-alltagitem").each(function(index,item){jQuery(item).removeClass("disabled")})},$scope.keepTag=function(){$scope.keeptagBool||($scope.keeptagBool=!0,commonService.fetch("sf.php?mod=contenttag&action=keepTag",{tid:threadData.tid,tagslist:$scope.showTagsList}).success(function(res){$scope.keeptagBool=!1,1==res.status&&window.location.reload(),showError(res.msg)}))},"undefined"!=typeof window.threadPostlistData&&window.threadPostlistData[threadData.tid]&&(postlistData=window.threadPostlistData[threadData.tid]);var _data=$scope.data={post:null};$scope.$watch("initData.pid",function(newValue,oldValue){(newValue!==oldValue||void 0!==newValue)&&(_state.pid=newValue,_data.post=postlistData[_state.pid])}),$scope.toggle=function(state){_state.isOpen=void 0===state?!_state.isOpen:state};var unWatchCount=$scope.$watch("data.post.comments.length",function(count){count&&($scope.toggle(!0),unWatchCount())})}).controller("threadlistCtrl",function($scope,$q,$window,$timeout,$interval,$location,commentService,commonService,threadData,memberData,forumData,caseThreadService,themeTag){function initCaseTag(product_id){var hasTagArray=threadData.casedatabasetags.split(",");caseThreadService.getProductTag(product_id,1,null).success(function(res){$scope.caseThread.childTags=[];for(var i=0;i<res.data.length;i++){res.data[i].checked=0;for(key in hasTagArray)if(res.data[i].id==hasTagArray[key]){res.data[i].checked=1;break}res.data[i].checked&&caseThreadService.getProductTag(product_id,2,null,res.data[i].id).success(function(childres){for(var i=0;i<childres.data.length;i++){childres.data[i].checked=0;for(key in hasTagArray)if(childres.data[i].id==hasTagArray[key]){childres.data[i].checked=1;break}}$scope.caseThread.childTags=$scope.caseThread.childTags.concat(childres.data)})}$scope.caseThread.mainTags=res.data}),caseThreadService.getProductTag(product_id,3,null).success(function(res){for(var i=0;i<res.data.length;i++){res.data[i].checked=0;for(key in hasTagArray)if(res.data[i].id==hasTagArray[key]){res.data[i].checked=1;break}}$scope.caseThread.versionTags=res.data})}if($scope.showTagsBool=!0,$scope.themeTag=themeTag,"undefined"!=typeof isProductManage){if($scope.threadData=threadData,$scope.caseThread={isOpenTagModel:!1,isOpenAuditModel:!1,tagList:[],tagListStr:"",mainTags:[],childTags:[],versionTags:[],versionTagStr:"",caseThreadInvisible:"undefined"!=typeof caseThreadInvisible?caseThreadInvisible:null,editAuditStatus:null,reason:""},threadData.casedatabasetags){var url="sf.php?mod=case_thread&action=get_tags_by_ids&tagids="+threadData.casedatabasetags;$scope.isLoading=!0,commonService.fetch(url).success(function(res){if($scope.isLoading=!1,res.status){$scope.caseThread.tagList=res.data;for(index in $scope.caseThread.tagList)3==$scope.caseThread.tagList[index].type&&($scope.caseThread.versionTagStr&&($scope.caseThread.versionTagStr+="、"),$scope.caseThread.versionTagStr+=$scope.caseThread.tagList[index].name),$scope.caseThread.tagListStr&&($scope.caseThread.tagListStr+="、"),$scope.caseThread.tagListStr+=$scope.caseThread.tagList[index].name}})}initCaseTag(threadData.cpid),$scope.selectMainTag=function(tag,index){if($scope.caseThread.mainTags[index].checked=!$scope.caseThread.mainTags[index].checked,$scope.caseThread.mainTags[index].checked)caseThreadService.getProductTag(tag.product_id,2,null,tag.id).success(function(res){for(var i=0;i<res.data.length;i++)res.data[i].checked=0;$scope.caseThread.childTags=$scope.caseThread.childTags.concat(res.data),$scope.caseThread.childTags=$scope.caseThread.childTags.sort(function(t1,t2){return parseInt(t1.id)<parseInt(t2.id)?-1:1})});else{for(var newChildArray=[],i=0;i<$scope.caseThread.childTags.length;i++)$scope.caseThread.childTags[i].main_id!=tag.id&&newChildArray.push($scope.caseThread.childTags[i]);$scope.caseThread.childTags=newChildArray.sort(function(t1,t2){return parseInt(t1.id)<parseInt(t2.id)?-1:1})}},$scope.editTag=function(){for(var newDatabaseTag="",checkboxs=angular.element(".m-content input[type=checkbox]"),i=0;i<checkboxs.length;i++)checkboxs[i].checked&&(""!=newDatabaseTag&&(newDatabaseTag+=","),newDatabaseTag+=checkboxs[i].value);$scope.isLoading=!0,commonService.fetch("sf.php?mod=case_thread&action=edit_case_tag",{tid:threadData.tid,tagids:newDatabaseTag}).success(function(res){if($scope.isLoading=!1,res.status){$scope.caseThread.isOpenTagModel=!1,threadData.casedatabasetags=newDatabaseTag,$scope.caseThread.tagList=[];var allTag=$scope.caseThread.mainTags.concat($scope.caseThread.childTags,$scope.caseThread.versionTags),selectTag=newDatabaseTag.split(",");allTag.forEach(function(item){for(var i=0;i<selectTag.length;i++)selectTag[i]==item.id&&$scope.caseThread.tagList.push(item)}),$scope.caseThread.versionTagStr="";for(index in $scope.caseThread.tagList)3==$scope.caseThread.tagList[index].type&&($scope.caseThread.versionTagStr&&($scope.caseThread.versionTagStr+="、"),$scope.caseThread.versionTagStr+=$scope.caseThread.tagList[index].name)}else showError(res.message)})},$scope.editCaseOnly=function(status){commonService.fetch("sf.php?mod=case_thread&action=edit_only",{tid:threadData.tid,only_status:status}).success(function(res){res.status?$scope.threadData.only_status=status:showError(res.message)})},$scope.openAuditModel=function(status){$scope.caseThread.editAuditStatus=status,$scope.caseThread.isOpenAuditModel=!0},$scope.closeAuditModel=function(status){$scope.caseThread.editAuditStatus=null,$scope.caseThread.isOpenAuditModel=!1},$scope.auditSubmit=function(){if(null!=$scope.caseThread.editAuditStatus&&""==$scope.caseThread.reason)showError("请填写理由");else{var invisible=$scope.caseThread.editAuditStatus?$scope.caseThread.editAuditStatus:0;commonService.fetch("sf.php?mod=case_thread&action=audit_case",{tid:threadData.tid,invisible:invisible,msg:$scope.caseThread.reason,readperm:$scope.threadData.readperm,only_status:$scope.threadData.only_status}).success(function(res){res.status?($scope.caseThread.caseThreadInvisible=invisible,$scope.caseThread.reason="",$scope.closeAuditModel()):showError(res.message)})}}}var _state=$scope.state={uid:memberData.uid,tid:threadData.tid,fid:forumData.fid,message:""},_data=$scope.data={postlist:[]};$scope.fastpost=function(params){var result=$q.defer();return params=angular.extend({fid:_state.fid,tid:_state.tid},params),commentService.reply(params).then(function(respond){var lastPost=respond.data.data;lastPost&&lastPost.success?(jQuery(".thread-bottom-fixed").length>0&&(jQuery(".thread-bottom-fixed #reply-btn span").html(parseInt(jQuery(".thread-bottom-fixed #reply-btn span").html())+1),jQuery(".thread-bottom-fixed #reply-btn").addClass("green-color")),aimgcount[lastPost.pid]=angular.isArray(lastPost.aimgs)?lastPost.aimgs:[lastPost.aimgs],_data.postlist.push(respond.data.data)):showError(respond.data.message),result.resolve()}),result.promise},$scope.isAllowEdit=function(authorid){return authorid===memberData.uid||memberData.groupid<=3||+memberData.allowadmincp},$scope.setRight=function(pid,tid){var url="forum.php?mod=op&pid="+pid+"&tid="+tid+"&agree=1";commonService.fetch(url).success(function(data){data.success?$scope.openModalFun("acceptAnsRet.html","sm"):data.message&&showError(data.message)})},$scope.modaction=$window.modaction;var findPostOffset,findPostId=$location.path().match(/pid\d+/);if("/lastpost"==$location.path())findPostOffset=angular.element("#postlist").find('>div[id^="post_"]:last').offset(),findPostOffset&&angular.element(window).scrollTop(findPostOffset.top-60);else if(findPostId)var canceler=$interval(function(){findPostOffset=angular.element("#"+findPostId[0]).offset(),findPostOffset&&(angular.element(window).scrollTop(findPostOffset.top-60),$interval.cancel(canceler))},400);else"/fastpost"==$location.path()&&(findPostOffset=angular.element("#fastpost").offset(),findPostOffset&&angular.element(window).scrollTop(findPostOffset.top-60))}).service("caseThreadService",["$http",function($http){return{getProductTag:function(productId,type,pid,mainId){return $http.post("sf.php?mod=forum&action=get_case_product_tag",{product_id:productId,type:type,pid:pid,main_id:mainId})}}}]).directive("post",function($timeout,$window){return{restrict:"A",templateUrl:"webapp/module/forum/view/post.html?v="+VERHASH,replace:!0,controller:"replyCtrl",link:function(scope,element,attrs){scope.page=attrs.page||1,$timeout(function(){$window.attachimgshow(scope.post.pid)},10)}}}).directive("fastpost",function($parse,$timeout,memberData,threadData,swfconfigData){return{restrict:"EA",templateUrl:"webapp/module/forum/view/fastpost.html?v="+VERHASH,replace:!0,scope:{message:"=?",replyHandler:"=onReply",allowat:"=?"},link:function(scope,element){function getInputSelection(el){var normalizedValue,range,textInputRange,len,endRange,start=0,end=0;return"number"==typeof el.selectionStart&&"number"==typeof el.selectionEnd?(start=el.selectionStart,end=el.selectionEnd):(range=document.selection.createRange(),range&&range.parentElement()==el&&(len=el.value.length,normalizedValue=el.value.replace(/\r\n/g,"\n"),textInputRange=el.createTextRange(),textInputRange.moveToBookmark(range.getBookmark()),endRange=el.createTextRange(),endRange.collapse(!1),textInputRange.compareEndPoints("StartToEnd",endRange)>-1?start=end=len:(start=-textInputRange.moveStart("character",-len),start+=normalizedValue.slice(0,start).split("\n").length-1,textInputRange.compareEndPoints("EndToEnd",endRange)>-1?end=len:(end=-textInputRange.moveEnd("character",-len),end+=normalizedValue.slice(0,end).split("\n").length-1)))),{start:start,end:end}}scope.updateTextarea=function(callback){var $textarea=element.find("textarea");$timeout(function(){var inputRange=getInputSelection($textarea[0]);$timeout(function(){if(void 0!=$textarea[0].selectionStart)$textarea[0].selectionStart=inputRange.start,$textarea[0].selectionEnd=inputRange.end;else if(document.selection&&document.selection.createRange){var sel=$textarea[0].createTextRange();sel.moveStart("character",inputRange.start),sel.moveEnd("character",inputRange.end-$textarea.val().length),sel.select()}}),$parse($textarea.attr("ng-model")).assign(scope,$textarea.prop("value")),callback&&callback.call(scope,$textarea.prop("value"))})},element.on("focus","textarea",function(){scope.updateTextarea()}),document.selection&&document.selection.createRange&&element.on("keyup mousemove mouseup","textarea",function(){this.sel=document.selection.createRange()}),smilies_show("fastpostsmiliesdiv",8,"fastpost"),scope.deleteAllAttachment=function(){var $=angular.element;$("#attachList0_tblheader").css("display","none"),$("#attachList0").html("")},scope.getAttachmentsOptions=function(){var $elems=element.find("[name^=attachnew]"),rs={};return $elems.each(function(i,elem){rs[elem.name]=elem.value}),rs}},controller:function($scope,$rootScope,scoreData,$http,commonService){var _state=$scope.state={uid:memberData.uid,fid:threadData.fid,tid:threadData.tid,swfconfig:swfconfigData,isLoading:!1};scoreData&&($scope.formScore=scoreData.formscores,$scope.$root.showScoreing=scoreData.enable&&!scoreData.scored,$scope.numberS=scoreData.numberS,$scope.picsrc=angular.element(".img-circle")[0]?angular.element(".img-circle")[0].currentSrc:null),$scope.reply=function(){if(scoreData){var i,allSelect=!0,selected=!1,scoreKeys=[],scoreVals=[],tid=threadData.tid;for(i=0;i<$scope.formScore.length;i++)allSelect=allSelect&&$scope.formScore[i].score,selected=selected||$scope.formScore[i].score;if(selected&&!allSelect)return void showError("请为完成所有的评分");if($scope.$root.showScoreing&&allSelect){for(i=0;i<$scope.formScore.length;i++)scoreKeys[i]=$scope.formScore[i].key,scoreVals[i]=$scope.formScore[i].score;$http({method:"POST",url:"sf.php?mod=score",data:{op:"score",scoreKeys:scoreKeys,scoreVals:scoreVals,tid:tid}}).then(function(ret){ret.data&&0===ret.data.result?($scope.$root.showScoreing=!1,_showCreditPrompt()):ret.data&&ret.data.message&&showError(ret.data.message)})}if(""==$scope.message)return!1}_state.isLoading=!0,$scope.updateTextarea(function(){var params=angular.extend({message:$scope.message},$scope.getAttachmentsOptions());"function"==typeof parseurl&&(params.message=parseurl(params.message)),$scope.replyHandler(params).then(function(){$scope.message="",showCreditPrompt()})["finally"](function(){_state.isLoading=!1}),$scope.deleteAllAttachment()})},$scope.openQuicklogin=$rootScope.openQuicklogin}}}).controller("RewardCountDownController",function($scope,$interval){var sec=0,min=0,stop=$interval(function(){sec=$scope.sec,min=$scope.min,sec>0?sec--:min>0?(min--,sec=59):$interval.cancel(stop),$scope.sec=sec,$scope.min=min},1e3)}).controller("qusController",function($scope,qusList,memberData,commonService){var _state=$scope.state={uid:memberData.uid,typeid:12,page:1,classes:"unaccept",perpage:5,reply_status:!0},_data=$scope.data={qusList:qusList,qusCount:qusCount||0};$scope.refreshQus=function(){var url="sf.php?mod=my_thread";Math.ceil(_data.qusCount/_state.perpage)<=_state.page?_state.page=1:_state.page++,$scope.isLoading=!0,commonService.fetch(url,_state).success(function(respone){$scope.isLoading=!1,respone.success&&(_data.qusList=respone.data)})},$scope.refreshAnsQus=function(tid){var url="sf.php?mod=forum&action=refresh_ansqus";$scope.isLoading=!0,commonService.fetch(url,{page:_state.page+1,tid:tid}).success(function(respone){$scope.isLoading=!1,respone.success?(_data.qusList=respone.data,respone.page?_state.page=respone.page:_state.page++):respone.message&&showError(respone.message)})},$scope.threadClose=function(){var url="sf.php?mod=forum&action=closethread&"+angular.element("form#qusForm").serialize();$scope.isLoading=!0,commonService.fetch(url).success(function(respone){$scope.isLoading=!1,showError(respone.message),respone.data.success&&($scope.close(),angular.element("#closeThread").hide())})},$scope.upReward=function(){var url="sf.php?mod=forum&action=upreward&"+angular.element("form#upRewardForm").serialize();$scope.isLoading=!0,commonService.fetch(url).success(function(respone){$scope.isLoading=!1,showError(respone.message),respone.data.success&&window.location.reload()})},$scope.chooseHelp=function(callback){$scope.needreason=!parseInt(callback)},$scope.submitHelp=function(){var url="sf.php?mod=forum&action=helpful&"+angular.element("form#helpfulForm").serialize();$scope.isLoading=!0,commonService.fetch(url).success(function(respone){$scope.isLoading=!1,showError(respone.message),respone.data.success&&angular.element("#helpfulForm").hide()})}}).controller("viewThreadBottomController",function($scope,$http){var _data=$scope.data={openHelp:!1,helpMessage:"",isHelp:!1};$scope.addHelpBack=function(tid,openHelp){_data.openHelp=openHelp,$http.post("forum.php?mod=thread_help&ajaxtype=add",{tid:tid,ishelp:1==_data.openHelp?1:0}).then(function(res){if(res.data.status){if(1==_data.openHelp)if(jQuery(".subject .help em").length>0){var count=parseInt(jQuery(".subject .help em").html())+1;jQuery(".subject .help em").html(count)}else jQuery(".subject .help").html("<em>1</em>人觉得有帮助");jQuery(".thread-bottom-fixed .does-help").html("<span>已反馈</span>")}})},$scope.addHelpBackContent=function(){_data.helpMessage?(jQuery("#fastpostmessage").val(_data.helpMessage),setTimeout(function(){jQuery(".post-box>button.btn").click()},100),_data.helpMessage="",_data.isHelp=_data.openHelp,_data.openHelp=!1):showError("请先填写内容！")}});var modules=["ngRoute","page","forum","databases.common","plateTagApp"];if("string"==typeof mod&&mod.length)try{angular.module(mod),modules.push(mod)}catch(err){}"undefined"==typeof debugMode&&modules.push("templates"),angular.module("app",modules).controller("DropdownCtrl",function($scope){$scope.status={isopen:!1},$scope.toggleDropdown=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.status.isopen=!$scope.status.isopen},$scope.selectForum=function(fid,fname){$scope.$parent.fid=fid,$scope.fname=fname},$scope.selectThreadType=function(typeid,typeName){$scope.$parent.typeid=typeid,$scope.typeName=typeName}}).controller("IndexController",function($scope){$scope.showMyFollowForum=function(){$scope.isShowMyFollowForum?location.href="forum.php?follow=1":location.href="forum.php"}});